---
title: 时序逻辑设计
categories: 
  - Theory
  - 数字电路与逻辑设计
  - 《数字设计和计算机体系结构》
tags:
  - 数字电路
  - 计算机系统结构
---

# 引言

时序逻辑的输出取决于当前的输入值和先前的输入值

时序逻辑可能明确的记住某些先前的输入，也可能从先前的输入中提取更少量信息，这些信息称为系统的**状态**

一个数字时序逻辑电路的状态由一组称为**状态变量**的位构成，这些状态变量包含用于解释电路未来行为所需要的有关过去的所有信息



# 锁存器和触发器

存储器件的基本模块是一个**双稳态元件**，该元件有两个稳定状态。



![image-20220613164311013](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131643066.png)

上图显示的是交叉耦合的反向器对：

因为Q值作为输入经过I_1和I_2两个反向器Q值不变，而$\bar Q$值只经过一个反向器故而保持与Q相反。

此时电路有两种稳定状态:Q=0；Q=1.

所以电路称为双稳态。



具有N种稳态的元件可以表示$log_2N$位的信息。



<!--当第一次给此时序电路加电时，它的初始状态是未知的并且通常是不可预测的-->



## SR锁存器

SR锁存器和交叉耦合反向器相似，但是它的状态可以通过输入S和R来控制，可以set和reset输出Q。

![image-20220613165555598](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131655627.png)

![image-20220613165616611](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131656642.png)

<!--输入的全部历史可以由状态变量Q解释。无论过去置位或复位是如何发生的，都需要通过最近一次置位或复位操作来预测SR锁存器的未来行为。-->

## D锁存器

Designing circuits becomes easier when these questions of **what** and **when** are separated. 

D锁存器有两个输入：

- 数据输入D，用来控制下一个状态的值；

- 时钟输入CLK，用来控制状态发生改变的时间

![image-20220613170321712](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131703744.png)

- D锁存器避免了S和R同时有效而造成的奇怪情况
- 当CLK=1时，D锁存器是透明的，就像一个缓冲器
- 当CLK=0时，D锁存器，阻塞新书局D通过D锁存器流向Q，Q保持原来的值不变
- D锁存器又称为透明锁存器、电平敏感锁存器



## D触发器

一个D触发器可以由反向时钟控制的两个背靠背的D锁存器构成

第一个锁存器L1称为**主锁存器**

第二个锁存器L2称为**从锁存器**

![image-20220613171146211](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131711248.png)

D触发器在时钟**上升沿**将D复制到Q，在其他时间D触发器保持原来的状态

时钟的上升沿也经常简称为时钟沿（clock  edge）

- 输入D确定新的状态，时钟沿确定状态发生改变的时间



D触发器也经常称为

- 主从触发器（master-slave flip-flop）
- 边沿触发器（edge-triggered flip-flop）
- 正边沿触发器（positive edge-triggered flip-flop）



电路中的三角形表示沿触发时钟输入。

当不需要$\bar Q$时，$\bar Q$经常被省略。



## 寄存器

一个N位寄存器由共享一个公共CLK输入的一排N个触发器构成

![image-20220613173021465](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131730511.png)



## 带使能端的触发器

带使能端的触发器（enabled flip-flop）增加了另一个称为EN或ENABLE的输入，该输入用于确定在时钟沿

![image-20220613173505252](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131735286.png)

<!--当CLK=1时，EN不能改变，以免触发器出现一个时钟毛刺（在不正确的时间进行切换）-->



## 带复位功能的触发器

带复位功能的触发器（resettable flip-flop）增加了一个称为RESET的输入。

当RESET=TRUE，带复位功能的触发器忽略D并将输出Q复位为0

触发器可能是：

- 同步复位——只在CLK上升沿进行复位
- 异步复位——任意时刻都可复位，与CLK无关

![image-20220613174202387](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131742433.png)

![image-20220613175025259](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131750317.png)



# 同步逻辑设计

## 一些有问题的电路

### 非稳态电路

环形振荡器（ring oscillator）

环形振荡器的周期取决于每个反向器的传播延迟。

很难预测环形振荡器的周期。

环形振荡器是一个零输入和一个周期性改变的输出的时序电路。

![image-20220613175841514](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131758552.png)

![image-20220613175848223](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206131758268.png)

### 竞争条件（race condition）

电路的行为取决于两条通过逻辑门的路径中哪条最快



## 同步时序电路

组合逻辑没有环路和竞争

为了避免包含环路的时序电路存在不良的竞争或不稳定的行为

设计师将电路转变成组合逻辑电路和寄存器的集合。

寄存器包含系统的状态，这些状态仅仅在时钟到达时发生改变。

状态**同步**于时钟信号。

如果时钟足够慢，使得在下一个时钟沿到达之前输入到寄存器的信号都可以稳定下来，所有的竞争都将被消除。

<!--反馈回路上总是使用寄存器-->



定义时序电路（同步）：

- 一个时序电路有一组有限的离散状态$\{S_0,S_1,...,S_{k-1}\}$

- 同步时序电路有一个时钟输入，上升沿表示庶徐电路状态转变发生的时间

- 当前状态和下一个状态用来区分目前系统的状态和下一个时钟沿系统将进入的状态

- 功能规范详细说明了对于当前状态和输入值的各种组合的下一个状态和输出值

- 时序规范包括

  - 上界时间$t_{pcq}$和下界时间$t_{ccq}$，它是从时钟的上升沿直到输出改变的时间

    $t_{pcq}$ stands for the time of propagation from clock to Q, where Q indicates the output of a synchronous sequential circuit. $t_{ccq}$ stands for the time of contamination from clock to Q. These are analogous to $t_{pd}$ and $t_{cd}$ in combinational logic.

  - 建立时间$t_{setup}$和保持时间$t_{hold}$它表示何时输入必须相对于时钟的上升沿稳定



同步时序电路的组成规则：

- 每一个电路元件或者是组合电路或者是寄存器
- 至少有一个电路元件是寄存器
- 所有寄存器接受同一个时钟信号
- 每个环路至少包含一个寄存器

## 同步电路和异步电路

同步电路和异步电路各有优缺点



# 有限状态机

![image-20220614153703991](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141537071.png)



## 有限状态机设计实例

![image-20220614155610245](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141556300.png)

![image-20220614155619423](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141556465.png)

![image-20220614155733125](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141557171.png)

![image-20220614160318754](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141603792.png)

![image-20220614160338601](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141603638.png)

![image-20220614160712729](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141607777.png)

- 状态寄存器在启动时收到一个同步或异步复位信号来初始化有限状态机。
- 在每个时钟沿，这个状态寄存器复制下一个状态$S'_{1:0}$到状态$S_{1:0}$
- 根据下一个状态方程画出下一个状态逻辑的电路图
- 根据输出方程画出输出逻辑的电路图

![image-20220614163940909](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141639972.png)



## 状态编码

- 二进制编码
- 独热编码
  - 状态的每一位表示一种状态



## Moore型状态机和Mealy型状态机

- Moore型状态机的输出仅和当前状态相关
- Mealy型状态机的输出取决于输入和当前状态

![image-20220614171353255](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141713306.png)

![image-20220614171404809](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141714868.png)



# 状态机的分解

![image-20220614172510161](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141725244.png)

![image-20220614172519347](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206141725393.png)





## 由电路图导出状态机

- Examine circuit, stating inputs, outputs, and state bits.
- Write next state and output equations. 
- Create next state and output tables. 
- Reduce the next state table to eliminate unreachable states. 
- Assign each valid state bit combination a name. 
- Rewrite next state and output tables with state names. 
- Draw state transition diagram. 
- State in words what the FSM does.

## 小结

Use the following procedure to design an FSM: 

- Identify the inputs and outputs. 
- Sketch a state transition diagram. 
- For a Moore machine:
  - Write a state transition table. 
  - Write an output table. 
- For a Mealy machine: 
  - Write a combined state transition and output table. 
- Select state encodings—your selection affects the hardware design. 
- Write Boolean equations for the next state and output logic. 
- Sketch the circuit schematic

状态转换图——>状态转换表和输出表——>布尔表达式——>电路草图



# 时序逻辑的时序

## 动态约束

在时钟上升时，输出在时钟Q的最小延迟后开始改变，并在时钟到Q的传播延迟内达到最终值。

为了对电路正确采样，在时钟的上升沿到来前，输入必须在建立时间内保持稳定，在时钟上升沿之后保持时间内保持稳定。

建立时间和保持时间统称为电路的孔径时间。

动态约束是指同步时序电路的输入必须在时钟沿附近的建立和维持孔径时间内保持稳定。

必须保证在触发器对信号进行采样时，信号不能变化。

采样时仅关心输入在孔径时间内的值，可以认为是每个时钟周期内的最终值，所以可以将信号当作时间和逻辑电平上都是离散的量

## 系统时序

时钟周期——重复的时钟信号的上升沿之间的时间

时钟频率——时钟周期的倒数

![image-20220617092753089](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206170927159.png)

1. 建立时间约束

   ![image-20220617092918165](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206170929206.png)

   - 最小周期等式：$T_c\ge t_{pcq}+t_{pd}+t_{setup}$
   - 建立时间约束 （最大延迟约束）$t_{pd}\le T_c-(t_{pcq}+t_{setup})$
     - 限制通过组合逻辑的最大约束
   - $t_{pcq}+t_{setup}$称为时序开销，通常由触发器制造商决定

   

2. 保持时间约束

   ![image-20220617094255881](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206170944545.png)
   
   - $t_{ccq}+t_{cd}\ge t_{hold}$
   
   - 保持时间约束，最小时间约束$t_{cd}\ge t_{hold}-t_{ccq}$
   
     ![image-20220617094522394](/home/Loverain/.config/Typora/typora-user-images/image-20220617094522394.png)
   
   - $t_{hold}\le t_{ccq}$
     - 一个可靠触发器的保持时间比它的最小延迟短

3. 小结
   - 时序电路中的建立时间和保持时间约束控制触发器之间的组合逻辑的最大延迟和最小延迟。
   - 现代触发器经常设计为可以使其组合逻辑的最小延迟是0,即触发器可以背靠背地放置。
   - 因为高的时钟频率意味着短的时钟周期，所以最大延迟约束限制了高速电路的关键路径上串联门的个数
   - 增加缓冲器通常能在不降低关键路径速度的同时解决保持时间问题

## 时钟偏移

时钟偏移——每个寄存器的时钟到达时间总是有所不同，这个时钟沿到达时间的变化称为时钟偏移。

引起时钟偏移的原因：

- 线路长度不同
- 时钟门控
- 噪声

![image-20220617103930900](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171039011.png)

![

](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171047781.png)

![image-20220617104741506](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171047545.png)

![image-20220617104800759](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171048824.png)

![image-20220617104813941](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171048005.png)

- 时钟偏移显著增加了建立时间和保持时间
- 增加时序总开销，减少组合逻辑的有效工作时间
- 增加了组合逻辑所需要的最小延迟
- 为了防止$t_{skem}>t_{ccq}$，背靠背触发器出现时间错误

## 亚稳态

![image-20220617111200365](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171112408.png)

![image-20220617111218196](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171112230.png)

- 触发器等双稳态设备的输入在孔径时间内发生改变，则输出在稳定到0或者1之前是一个亚稳态值。
- 达到稳态的时间是无界的，因为对于任何有限时间t，触发器仍处于亚稳态的概率都不是0。
- 但是这个概率随着t的增加而指数级下降

### 同步器

对于数字系统，来自真实世界的异步输入是不可避免的。

数字系统设计人员的目标是：对于给定的异步输入，确保遇到的亚稳态电压的概率足够小。

为了确保产生正确的逻辑电平，所有的异步输入必须经过**同步器**。

同步器有如下特性：

- 接受异步输入信号D和时钟CLK
- 在有限时间内，他产生输出Q，输出为有效逻辑电压的概率很高
- 如果在孔径时间内D是稳定的，则Q将会取与D一样的值
- 如果在孔径时间内D发生变化，则Q可能取HIGH或LOW，但它一定不会是亚稳态。
- 如果同步器的输出Q是亚稳态，那么这个同步器将失效

![](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171453293.png)

![image-20220617113108149](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171131191.png)

![image-20220617113117186](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171131239.png)

![image-20220617113630597](https://cdn.jsdelivr.net/gh/jdccccc/PictureBed/img/202206171136643.png)

Mean Time Between Failure —— 平均系统失效间隔时间



# 并行

系统的速度可以使用延迟和通过系统的信息吞吐量来度量

任务——经过处理后，能产生一组输出的一组输入。

延迟——从开始到结束所需要的时间。

吞吐量——系统单位时间内产生任务的数量。

并行——在同一时间内处理多个任务可以提高吞吐率。

空间并行——提供多个相同的硬件，多个任务可以在同一时间一起处理。

时间并行——将一个任务分成多个阶段，任意给定的时间内每段都有一个不同的任务，从而使多个人物可以重叠起来。

- 时间并行通常称为流水线（pipelining）



在没有并行的系统中，吞吐量为：
$$
1/L
$$
在空间并行系统中有N个相同的硬件，吞吐量为：
$$
N/L
$$
在时间并行系统中，延迟最长的段延迟为$L_1$:
$$
1/L_1
$$


<!--将寄存器放在组合逻辑块之间以便将逻辑块分成可以用较快时钟运行的较短阶段-->



并行的克星是依存关系：

如果当前的任务依赖于前一个任务的结果，而不是当前任务中的前一步结果，则只有前一个任务完成后，后一个任务才能开始。

