# CloudComputing 笔记
# 1 云计算

## 云计算的特点

- 按需自助服务
- 广泛的网络接入
- 资源池化
- 快速弹性伸缩
- 可计量服务

## 云计算的定义

美国国家标准与技术研究院（NTSI）定义：云计算是一种模型，它可以实现随时随地、便捷地、随需应变地从可配置计算资源共享池中获取所需的资源（例如，网络、服务器、存储、应用及服务），资源能够快速供应并释放，使管理资源的工作量和与服务提供商的交互减小到最低限度。

## 云计算的起源和发展

### 互联网发展

APARNET->TCP/IP->APARNET,SATNET,PRNET->DNS->MERS->ARCHIE->WWW

### 计算发展

- 串行计算
- 并行计算
- 分布式计算
- 网格计算

### 云计算发展

- 云计算1.0
  - 面向数据中心管理员的IT基础设施虚拟化阶段
- 云计算2.0
  - 面向基础设施云租户和云用户的资源服务化与管理自动化阶段
- 云计算3.0
  - 面向企业IT应用开发者及管理维护者的企业应用架构的分布式微服务化和企业数据架构的互联网化重构及大数据智能化阶段

### 云计算的模式

- 运营模式
  - 公有云
  - 私有云
  - 混合云
  - 行业云
- 服务模式
  - IaaS
  - PaaS
  - SaaS

# 2 计算虚拟化

- 云计算1.0时代使用的主要技术是虚拟化
- 虚拟化只提供了IaaS模式的服务，而云计算还提供了其他模式的服务

## 虚拟化简介

- 虚拟化的本质就是将原先的物理设备进行逻辑化，转化成一个文件夹或文件，实现软硬件的解耦。
- 使用虚拟化后，物理服务器转变成一个文件夹或文件，这里面一般会包含两部分，一部分用来记录虚拟机的配置信息，另一部分用来保存用户数据的磁盘文件。
- 虚拟机的动态迁移为高可用性HA、动态资源调度DRS和分布式电源管理DPM等高级特性提供了可能

- 发展
  - 1972年的时候，IBM正式将system370机的分时系统命名为虚拟机
  - 1999年，VMware推出了最早的能在x86架构上运行的虚拟化产品。
  - 20世纪90年代，伦敦剑桥大学的Lan Pratt和Keir Fraser在一个叫做Xenoserver的研究项目中，开发了Xen虚拟机。、
  - KVM的开发人员并没有选择从底层开始重新写一个Hypervisor，而是选择基于Linux kernel，通过加载新的模块使Linux Kernel本身变成一个Hypervisor。
  - 当x86架构虚拟化发展地如火如荼时，一种轻量级的虚拟化也在慢慢发展着，那就是容器。
- 基础概念
  - 运行虚拟机的物理主机称为宿主机，即**Host Machine**
  - 宿主机安装运行的操作系统称为宿主机操作系统，即**Host OS**
  - 运行在宿主机上的虚拟机称为客户机，即**Guest Machine**
  - 虚拟机安装运行的操作系统称为客户机操作系统，即**Guest OS**
  - 位于Host OS和Guest OS之间的是所有虚拟化技术的核心——**Hypervisor**，也可以称为**VMM**（Virtual Machine Monitor）

- 根据Hypervisor分类的虚拟机
  - I型裸金属虚拟化，Hypervisor直接调用硬件资源，不需要底层Host OS
  - II型宿主型虚拟化，此模型的物理资源由Host OS管理，实际的虚拟化功能由VMM提供，而VMM作为底层操作系统上的一个普通应用程序，通过其创建相应的虚拟机，共享底层服务器资源
  - 都具有**分区、隔离、封装和独立**的特点

## 计算虚拟化

计算虚拟化根据虚拟机组成的设备类型包含**CPU虚拟化、内存虚拟化和IO虚拟化**

### CPU虚拟化

**CPU的分级保护域**

Ring0、Ring1、Ring2和Ring3，

- 其中Ring0的权限最高，Ring1次之，Ring2再次之，Ring3最低。
- Ring0的权限可以直接操作硬件，一般只有操作系统和驱动会允许拥有此权限。
- Ring3的权限最低，所有程序都可以拥有此权限。

**指令分类**

- **特权指令**：是指用于操作和管理关键系统资源的指令，这些指令只在最高特权级上才能够运行，即必须在Ring 0级别上才能运行的指令。
- **普通指令**：与特权指令相对的是普通指令，这些指令在CPU普通权限级别上就能够运行，即在Ring 3级别上就可以运行的指令。
- **敏感指令**：在虚拟化环境中，还有一种特殊指令被称为敏感指令。敏感指令是指**修改虚拟机的运行模式或宿主机状态的指令**，也就是说将Guest OS中原本需要在Ring 0模式下才能运行的特权指令剥夺特权后，交给VMM来执行的指令。



**经典虚拟化方式**

**特权解除（Privilege deprivileging）”和“陷入模拟（Trap-and-Emulation）”**，它的基本原理是，将Guest OS运行在非特权级（即“特权解除”），而将VMM运行在最高特权级（即完全控制系统资源）。



**x86虚拟化漏洞三种解决方案**

- 全虚拟化（VMware，KVM）

  将所有虚拟机发出的操作系统请求转发到虚拟机监视器（VMM），虚拟机监视器对请求进行二进制翻译（Binary Translation），如果发现是特权指令或敏感指令，则陷入到VMM模拟执行，然后调度到CPU特权级别上执行；如果只是应用程序指令则直接在CPU非特权级别上执行。

- 半虚拟化（Xen）

  修改虚拟机操作系统Guest OS，让虚拟机操作系统能够意识到自己是被虚拟化的，虚拟机操作系统会“超级调用”（Hypercall）Hypervisor层来替换虚拟化中的敏感指令，从而实现虚拟化，而其它应用程序等非敏感或非特权请求则直接在CPU非特权级别上执行

- 硬件辅助虚拟化

  让虚拟机监视器VMM运行在root模式下，而root模式位于CPU指令级别Ring 0下。特权和敏感指令自动在Hypervisor上执行，所以无需全虚拟化或半虚拟化技术。

### 内存虚拟化

内存虚拟化就是把物理机的真实物理内存统一管理，包装成多份虚拟的内存给若干虚拟机使用。内存虚拟化技术的核心在于引入一层新的地址空间——客户机物理地址空间。

- 内存虚拟化的内存地址转换涉及到三种内存地址，即虚拟机内存地址（Virtual Memory Address，即VA）、物理内存地址（Physical Memory Address，即PA）和机器内存地址（Machine Memory Address，即MA）。
- 为了能够在物理主机上运行多个虚拟机，需要实现 VA（虚拟内存）→PA（物理内存）→MA（机器内存）之间的地址转换。
- 虚拟机Guest OS控制虚拟地址到客户内存物理地址的映射（VA→PA），但是虚拟机Guest OS不能直接访问实际机器内存。
- 因此Hypervisor需要负责映射客户物理内存到实际机器内存（PA→MA）。

### I/O虚拟化

- 全虚拟化

  虚拟机无论使用任何类型的操作系统，操作系统都不需要为I/O虚拟化做任何修改，就可以让多个虚拟机直接使用物理服务器的I/O设备。

- 半虚拟化

  主动让虚拟机把I/O请求发送给特权虚拟机，再由特权虚拟机访问真实的I/O设备，这就减少了VMM的性能损耗。

- 硬件辅助虚拟化（主流技术）

  硬件辅助虚拟化不同于前面两种方式，它是将I/O设备驱动直接安装在虚拟机操作系统中，不需要对操作系统做任何修改即可使用。

### 主流的计算虚拟化

- 开源的虚拟化包括KVM和Xen
- 闭源的虚拟化包括微软的Hyper-v、VMware的vSphere、华为的FusionSphere等。

#### Xen

Xen与KVM不同，它直接运行在硬件上，然后在其之上运行虚拟机，Xen中的虚拟机分为两类：Domain0和DomainU，Domain0是一个特权虚拟机，具有直接访问硬件和管理其它普通虚拟机DomainU的权限，在其它虚拟机启动前，Domain0需要先启动。DomainU是普通虚拟机，不能直接访问硬件资源，所有的操作都需要通过前后端驱动的方式转给Domain0，再由Domain0完成具体的操作后将结果返回给DomainU。

#### KVM

全称是Kernel-based Virtual Machine（基于内核的虚拟机），是一种典型的II型全虚拟化。

安装了KVM的Linux系统的**三种运行模式**：

- **Guest Mode**：此模式主要是指虚拟机，包括虚拟机的CPU、内存、磁盘等虚拟设备，该模式被置于一种受限的CPU模式下运行；
- **User Mode**：用户空间，此模式下运行的主要是QEMU，它用来为虚拟机模拟执行I/O类的操作请求；
- **Kernel Mode**：内核空间，此模式下可以真正操作硬件，当Guest OS执行I/O类操作或特权指令操作时，需要向用户模式提交请求，然后由用户模式再次发起硬件操作请求给内核模式，从而真正操作硬件。

**KVM核心模块+QEMU一起才能构成一个完整的虚拟化技术**

- KVM核心模块提供虚拟化功能
- QEMU提供外围设备功能
- virtio可以使I/O流传输跳过KVM，在虚拟机和QUME之间直接流动，KVM仅起通知作用，是QEMU I/O功能的改进方案



**Libvirt**

- 一个开源项目，它是一个非常强大的管理工具，被管理的虚拟化平台可以是KVM，也可以是Xen、VMware以及Hyper-V等等。
- Libvirt可以被很多应用使用，除了本身的virsh命令集外，Virt-manager、Virt-viewer、Virt-install都可以通过Libvirt管理KVM虚拟机。
- Libvirt作为管理工具和Hypervisor的中间层，向下可以对接各种Hypervisor，比如KVM、Xen等，向上可以提供各种语言的API，而且它对上层的用户来说是完全透明的。

## FusionCompete简介

**FusionSphere和FusionCompete的关系**

- **FusionSphere虚拟化套件**通过在服务器上部署虚拟化软件，使一台物理服务器可以承担多台服务器的工作。通过整合现有的工作负载并利用剩余的服务器，以部署新的应用程序和解决方案，实现较高的整合率。
- Fusionsphere：
  - Fusioncompete（公有云）
    - 计算节点CNA
    - 管理节点VRM
  - Fusionmanage（私有云）（借用openstack做二次开发）
  - ebackup（用于备份）
    - 增量备份
    - 全量备份
    - 差异备份
  - UltraVR（容灾）
- **FusionCompute**是**FusionSphere虚拟化套件中的必选组件**，是**云操作系统软件**，主要负责硬件资源的虚拟化，以及对虚拟资源、业务资源、用户资源的集中管理。



**FusionCompete的组成**

- CNA（Node Agent，计算节点代理）

  CNA相当于KVM中QEMU+KVM模块，主要提供虚拟化功能，通常是以集群的方式部署，将集群内的计算、存储和网络资源虚拟化成资源池供用户使用。

- VRM（Virtual Resource Manager,虚拟资源管理器）

  VRM相当于KVM中的管理工具，管理员和用户可以通过图形化的Portal对FusionCompute进行管理和使用。



**UVP**（Unified Virtualization Platform)

- FusionCompete的Hypervisor
- 裸金属架构



# 3 网络基础

## 虚拟化中的网络架构

### 虚拟化中的网络流量

- 在云计算和虚拟化中，数据中心的流量分为南北向流量和东西向流量
- 经过路由器的流量为南北向流量
- 不经过路由器的流量为东西向流量
- 虚拟机也是构成网络的一部分，它们几乎都是通过网桥接入到网络中
- 一个虚拟机可以有多个虚拟网卡，通过虚拟网卡，虚拟机可以与一台虚拟交换机相连，也可以同时与多个虚拟交换机相连。

### 网络基本概念

- 广播和单播
- 路由和默认网关
  - 默认网关收到通信请求时，如果自己的路由表中存在目的地址的网段，则会替通讯的发起者进行路由的转发，如果自己的路由表中没有目的地址，它会给发起者返回一个目的地址不可达的消息。
  - 默认网关是路由的一种特殊形式，它是路由转发时的最后选择，如果没有其它的路由条目进行转发，则使用默认网关进行转发。
- VLAN
  - VLAN是将一个物理的LAN在逻辑上划分成多个广播域的通信技术。
  - 同一个VLAN内的主机间可以直接通信
  - 不同VLAN内的主机间不能直接通信，从而将广播报文限制在一个VLAN内。

| 接口类型   | 对接收不带Tag的报文处理                                      | 对接收带Tag的报文处理                                        | 发送帧处理过程                                               |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Access接口 | 接收该报文，并打上缺省的VLAN ID。                            | 当VLAN ID与缺省VLAN ID相同时，接收该报文。当VLAN ID与缺省VLAN ID不同时，丢弃该报文。 | 先剥离帧的PVID Tag，然后再发送。                             |
| Trunk接口  | 打上缺省的VLAN ID，当缺省VLAN ID在允许通过的VLAN ID列表里时，接收该报文。打上缺省的VLAN ID，当缺省VLAN ID不在允许通过的VLAN ID列表里时，丢弃该报文。 | 当VLAN ID在接口允许通过的VLAN ID列表里时，接收该报文。当VLAN ID不在接口允许通过的VLAN ID列表里时，丢弃该报文。 | 当VLAN ID与缺省VLAN ID相同，且是该接口允许通过的VLAN ID时，去掉Tag，发送该报文。当VLAN ID与缺省VLAN ID不同，且是该接口允许通过的VLAN ID时，保持原有Tag，发送该报文。 |

## 虚拟化中的物理网络

**三层设备**

某台设备具备了路由功能，可以查看路由表，我们就把它当成三层设备，如果仅可以划分VLAN，就把它当成二层设备

- 第一层：物理服务器的网卡、连接网卡的网线以及光纤等线路、Hub
- 第二层：交换机
- 第三层：路由器



**服务器接入网络的方式**

- ToR（Top of Rack，柜顶接入）
- EoR（End of Row，列头接入）



**网络流量（的用途）分类**

- 业务流量
- 管理流量
- 存储流量



根据是否启用**LACP（Link Aggregation Control Protocol，即链路聚合控制协议），链路聚合**分为

- 手工负载分担模式

  手工负载分担模式下，链路的创建、成员接口的添加由手工配置，不需要链路聚合控制协议的参与。

- LACP模式

  LACP为交换数据的设备提供了一种标准的协商方式，以供设备根据自身配置自动形成聚合链路并启动聚合链路来收发数据。形成聚合链路后，LACP负责维护链路状态，在聚合条件发生变化时，自动调整或解散链路聚合。

## 虚拟化中的虚拟网络

### 虚拟网络架构

![image-20210712154600335](/images/image-20210712154600335.png)

- 在个人或者小型的虚拟化中，虚拟机会以桥接或者NAT的方式与物理网卡绑定
- 在企业级的大规模场景下，虚拟机都是通过虚拟交换机连接到物理网络的
- 网桥就是把一台机器上的若干个网络接口“连接”起来，其中一个网口收到报文时会复制给其它网口，这样网口之间就能够正常通信了。
- 当有了虚拟化后，每个虚拟机都会有一个虚拟网卡，Linux操作系统会在用户态生成一个TAP设备，同时，在内核态生成一个tun/tap的设备驱动和虚拟网卡驱动。



**虚拟交换机**

- 普通虚拟交换机

  普通虚拟交换机只运行在一台单独的物理主机上，所有与网络相关的配置只适用于此物理服务器上的虚拟机

- 分布式虚拟交换机

  分布式虚拟交换机分布在不同的物理主机上，通过虚拟化管理工具，可以对分布式虚拟交换机进行统一地配置。

  虚拟机能够进行热迁移的条件之一就是要有分布式虚拟交换机。

### 华为虚拟化产品的网络特性

#### 网络方案

**分布式虚拟交换机**分布在不同的物理主机上，通过虚拟化管理工具，可以对分布式虚拟交换机进行统一地配置。虚拟机能够进行热迁移的条件之一就是要有分布式虚拟交换机。

**DVS基本特征**

- 拟化管理员可以配置多个分布式交换机，每个分布式交换机可以覆盖集群中的多个CNA节点；
- 每个分布式交换机具有多个分布式虚拟端口VSP，每个VSP具有各自的属性（速率，统计），为了管理方便采用端口组Port Group来管理具有相同属性的一组端口，相同端口组的VLAN相同； 
- 虚拟化管理员或业务系统（例如VDI/IDC）可选择管理/存储/业务使用的不同物理接口；每个分布式交换机可以配置一个UpLink端口或者一个Uplink端口聚合组，用于VM对外的通信。Uplink端口聚合组可以包含多个物理端口，端口聚合组可以配置负载均衡策略； 
- 每个VM可以具有多个vNIC接口，vNIC可以与交换机的VSP一一对接；
- 虚拟化管理员或业务系统可根据业务需求，在一个集群中选择允许进行2层迁移的服务器创建虚拟二层网络，设置该网络使用的VLAN信息；



**上行链路:** 分布式交换机关联的服务器物理网口，管理员可以查询上行链路的名称、速率、模式、状态等信息。

**上行链路聚合:** 分布式交换机关联的服务器绑定网口，绑定网口可以包含多个物理网口，这些物理网口可以配置主备或负载均衡策略。

华为的分布式虚拟交换支持基于开源Open vSwitch的纯软件的虚拟交换功能。

#### 分布式交换机流量走向描述

- 虚拟机运行在相同主机，但是端口组不同
  - 这两台虚拟机的访问流量需要从主机内部传出到物理的接入交换机，转发到三层设备经过路由后再进入到主机内部，才能完成通信。
- 虚拟机运行在相同主机，且端口组相同
  - 属于同一端口组，则虚拟机属于同一广播域，而虚拟交换机支持广播。所以，如果是同主机相同端口组的虚拟机之间互相通信，可以直接通过虚拟交换机完成，通信的流量不需要传出到物理网络中。
- 虚拟机运行在不同主机，但端口组相同
  - 如果虚拟机使用相同端口组，但是运行在不同物理服务器时，流量需要通过物理服务器的网口传出到物理交换机上，然后才能完成通信。与不同物理服务器不同端口组不一样，此时两台虚拟机之间可以不经过三层设备即可正常通信。
- 同一物理服务器运行不同的DVS
  - 如果使用了不同的DVS，两台DVS上的端口组的VLAN ID不会相同，这就意味着虚拟机会使用不同的IP地址，所以与第一种情况类似，虚拟机之间的通信，数据包会先到三层设备进行路由，然后才能正常通信。

#### 安全组

- 位于同一个安全组的所有虚拟机网卡都将使用该安全组规则进行网络通信。每块虚拟机网卡只能加入一个安全组中。
- 安全组的作用与防火墙类似，在功能上可以参考防火墙，都是使用iptables的包过滤来实现安全控制的。

#### 虚拟交换模式

- 普通模式
- SR-IOV直通模式
- 用户态交换模式

# 4 虚拟化中的存储基础

![image-20210712213006206](/images/image-20210712213006206.png)

## 常见的物理磁盘类型

### 机械硬盘

机械硬盘主要由

- 盘片

- 主轴组件

- 浮动磁头组件

- 磁头驱动机构

- 前驱控制电路

- 接口

  等组成

按照接口种类就可分为

- SATA
- SAS
- NL-SAS

### 固态硬盘

- 固态硬盘由主控芯片和存储芯片组成
- 存储芯片按介质分为两种，最常见的一种是采用闪存（Flash芯片）作为存储介质，另一种是采用动态随机存取存储器（DRAM）作为存储介质。



|          | **固态硬盘**                 | **SAS**                          | **NL-SAS**                                | **SATA**                             |
| -------- | ---------------------------- | -------------------------------- | ----------------------------------------- | ------------------------------------ |
| 性能     | 非常高                       | 高                               | 较高                                      | 较高                                 |
| 可靠性   | 一般                         | 高                               | 较高                                      | 一般                                 |
| 价格     | 很高                         | 高                               | 较便宜                                    | 便宜                                 |
| 能耗     | 一般                         | 高                               | 较低                                      | 较低                                 |
| 推荐场景 | 适合数据访问非常大的用户使用 | 适合数据较为离散的高中端用户使用 | 适合较大数据块、业务I/O压力不大的用户使用 | 适合大数据块、业务压力不大的用户使用 |

## 集中式存储和分布式存储

### 集中式存储

- SAN(Storage Area Network)

  SAN是一个由存储设备和各种系统部件构成的网络架构，包括要使用存储设备资源的服务器、用于连接各存储设备的主机总线适配器（host bus adapter，HBA）卡以及FC交换机等。

  - FCSAN（光纤通道存储区域网络）

    在FC-SAN中，存储服务器上通常配置两个网络接口适配器：一个用于连接业务IP网络的普通网卡（network interface card，NIC），服务器通过该网卡与客户机交互；另一个网络接口适配器是与FC-SAN连接的主机总线适配器（hoat bus adaptor，HBA），服务器通过该适配器与FC-SAN中的存储设备通信。

  - IPSAN（IP存储区域网络）

    IP-SAN是标准的TCP/IP协议和SCSI指令集相结合的产物，是基于IP网络来实现块级数据存储的方式。

  - SASSAN

  - FCoESAN

- NAS(Network Attached Storage)

  - 网络附加存储（network attached Storage，NAS）是一种将分布、独立的数据整合为大型、集中化管理的数据中心，以便于不同主机和应用服务器进行访问的技术。
  - NAS的软件按照功能可以划分为操作系统、卷管理器、文件系统、网络文件共享和Web管理5个模块。
  - NAS设备支持对公用互联网文件系统（common internet file system，CIFS）或网络文件系统（network file system，NFS）进行读写，也支持同时对两者进行读写。
  - NFS与平台无关的文件共享机制是基于XDR/RPC协议实现的。

### RAID机制

- Redundant Arrays of Independent Disks，冗余磁盘阵列
- 具有RAID-0～RAID-6 共7种基本的RAID级别
  - RAID0 
    - RAID-0也称为条带化（stripe）
    - 它代表了所有RAID级别中最高的存储性能，不具有冗余，但速度最快
  - RAID1
    - RAID-1又称为Mirror或Mirroring（镜像），其目的是最大限度地保证用户数据的可用性和可修复性。RAID-1的原理是把用户写入硬盘的数据百分之百地自动复制到另外一个硬盘上。
  - RAID5
    - 当RAID5的一个磁盘数据发生损坏后，利用剩下的数据和相应的奇偶校验信息可以恢复被损坏的数据。因此，RAID-5是一种存储性能、数据安全和存储成本兼顾的存储解决方案。
  - RAID6
    - RAID-6的数据安全性比RAID-5高，即使阵列中有两个磁盘故障，阵列依然能够继续工作并恢复故障磁盘的数据。
    - 常见的RAID-6技术有P+Q和DP两种，这两种技术获取校验信息的方法不同，但是都可以允许整个阵列中两块磁盘数据丢失。

### 分布式存储和副本机制

- 分布式存储是通过副本机制来实现数据的高可靠性的。
- 副本机制是指将数据复制成多份一模一样的内容，并分别保存在不同的服务器上，当某台服务器出现故障后，数据并不会丢失。
- 分布式存储系统把所有服务器的本地硬盘组成若干个资源池，基于资源池提供创建/删除应用卷（Volume）、创建/删除快照等接口，为上层软件提供卷设备功能。
- Partition是数据多副本的基本单位。
- 在应用程序读数据时，并不会读取所有的副本数据，而是会读取主用副本中的数据，在主用副本不可用时，才会读取其它副本数据。

![image-20210713110023066](/images/image-20210713110023066.png)

![image-20210713110032673](/images/image-20210713110032673.png)

## 虚拟化存储和非虚拟化存储

- 虚拟化，仅指集群是否有文件系统

  - 这里的文件系统可以是NFS文件系统，也可以是虚拟化集群的文件系统。

- 在云计算中，虚拟化程序会对逻辑卷进行格式化，各个厂商的虚拟化文件系统各不相同

  - VMware使用的是VMFS（Virtual Machine File System）

  - 华为使用的是VIMS（Virtual Image Manage System）

    - 以VIMS为例，它是一种基于SAN存储的集群文件系统，因此使用FusionStorage提供存储空间时，只能是非虚拟化存储

    - 虚拟化程序使用的最小存储单位为LUN（Logical Unit Number）

      - Thick LUN

        Thick LUN创建完成后就会从存储池中分配满额的存储空间

      - Thin LUN

        当Thin LUN已分配存储空间的使用率达到阈值时，存储系统才会从存储池中再划分一定的存储空间给Thin LUN，直到Thin LUN等于设定的全部容量为止，因此它拥有较高的存储空间利用率。

- 操作系统只维护本机的目录，而集群需要维护NAS或者集群文件系统形成的共享目录。

  - 常见的操作系统文件格式包括：FAT32（微软）、NTFS（微软）、UFS（UNIX）、EXT2/3/4（Linux）等。

    ![image-20210713113903284](Cloud-Computing%E7%AC%94%E8%AE%B0.assets/image-20210713113903284.png)

## 虚拟机磁盘

- 如果使用虚拟化存储，所有的磁盘文件都会以文件的形式存放到文件系统形成的共享目录中。

- 如果使用非虚拟化存储，每个磁盘文件对应一个LUN。

- 各厂商都有自己的虚拟机磁盘格式转换工具，可以将其它的格式转换成自己产品可用的格式：


  | 虚拟机磁盘文件格式 | 支持的厂商                     |
  | ------------------ | ------------------------------ |
  | RAW                | 各厂商通用                     |
  | VMDK               | VMware                         |
  | VHD                | 微软Hyper-V、华为FusionCompute |
  | QCOW               | QEMU或KVM虚拟化平台专用的格式  |
  | QED                |                                |
  | VDI                | Oracle                         |

## 华为虚拟化产品的存储特性

### 华为虚拟化产品存储架构

![image-20210713114102826](/images/image-20210713114102826.png)

- 数据存储

  - 数据存储是FusionCompute对存储资源中的存储单元进行的统一封装。存储资源封装成数据存储并与主机关联后，能进一步创建成若干个虚拟磁盘，供虚拟机使用。

  - 能够封装为数据存储的存储单元包括：

    · SAN存储（包括iSCSI或光纤通道的SAN存储）上划分的LUN。

    · NAS存储上划分的文件系统。

    · FusionStorage Block上的存储池。

    · 主机的本地硬盘（虚拟化）。

- 存储设备

- 存储资源

  - 在使用数据存储前，需要手动添加存储资源。
  - 如果存储资源是IPSAN、FusionStorage或者NAS存储时，需要为集群内的主机添加存储接口，然后通过这个接口与集中式存储控制器的业务接口或者FusionStorageManager的管理地址进行通信。
  - 如果存储资源是FCSAN，则不需要单独添加存储接口。

### 华为虚拟机磁盘特性

- 类型

  - 普通

    普通磁盘只能提供给单个虚拟机使用。

  - 共享

    共享磁盘可以绑定给多个虚拟机使用。

  - 多个虚拟机使用同一个共享磁盘时，如果同时写入数据，有可能会导致数据丢失。若使用共享磁盘，需要通过应用软件来保证对磁盘的访问控制。

- 配置模式

  - 普通

    该模式下，磁盘分配空间即为磁盘容量，在创建过程中会将物理设备上保留的数据置零。这种格式的磁盘性能要优于其它两种磁盘格式，但创建这种格式的磁盘所需的时间可能会比创建其它类型的磁盘长。

  - 精简

    在该模式下，系统首次仅分配磁盘容量设置值的一部分，后续根据使用情况，逐步进行分配，直到分配总量达到磁盘容量配置值为止。同时，在此模式下，数据存储支持超分配，但是建议超分配的比例不超过50%，即假设“总容量”为100G，“已分配容量”建议不要超过150G。同理，如果发现“已分配容量”大于“实际容量”，则表示该磁盘模式为精简。

  - 普通延迟置零

    该模式下，磁盘容量即为磁盘分配空间，但创建时不会擦除物理设备上保留的任何数据，而从虚拟机首次执行写操作时开始会按需将其置零。其创建速度比“普通”模式快；I/O性能介于“普通”和“精简”两种模式之间。这种磁盘的配置模式只支持数据存储类型为“虚拟化本地硬盘”或“虚拟化SAN存储”。

- 磁盘模式

  - 从属

    快照中包含该磁盘，更改将立即并永久写入磁盘

  - 独立-持久

    更改将立即并永久写入磁盘，持久磁盘不受快照影响。

  - 独立-非持久

    关闭电源或恢复快照后，丢弃对该磁盘的更改。

  - 若选择“独立-持久”或“独立-非持久”

    - 对虚拟机创建快照时，不对该磁盘的数据进行快照。使用快照还原虚拟机时，不对该磁盘的数据进行还原。
    - 如果快照后，该磁盘被解绑定且未绑定其它虚拟机，则快照恢复的虚拟机会重新绑定该磁盘，但磁盘数据不进行还原。
    - 如果快照后，该磁盘被删除，则快照恢复的虚拟机上不存在该磁盘。

  - 磁盘类型和配置模式一旦设定后就不支持更改，而磁盘模式设定后还可以相互转换。

# 5 虚拟化特性介绍

![image-20210713140157030](/images/image-20210713140157030.png)

## 虚拟化集群特性

集群是一种把一组计算机组合起来作为一个整体向用户提供资源的方式，在虚拟化集群中可以提供计算资源、存储资源和网络资源。

### HA特性

HA实现的基本原理：使用集群技术，克服单台物理主机的局限性，最终达到业务不中断或者中断时间减少的效果。在虚拟化中的HA只保证计算层面，具体来说，虚拟化层面的HA是虚拟机系统层面的HA，即当一台计算节点出现故障时，在集群中的另外一台节点中能快速自动的将其启动起来。

### 负载均衡

负载均衡是一种集群技术，它将特定的业务（网络服务、网络流量等）分担给多台网络设备（包括服务器、防火墙等）或多条链路，从而提高了业务处理能力，保证了业务的高可靠性。

### 易扩容

- 纵向扩容（Scale-up）
  - 升级单台设备的硬件
- 水平扩容（Scale-out）。
  - 增加资源池中资源，具体在实施的时候，只需要增加服务器的数量

### 内存复用

内存复用是指在服务器物理内存一定的情况下，通过一定技术手段，使得虚拟机内存总和大于服务器物理内存总和，提高服务器中虚拟机密度。

- 内存共享
  - 多台虚拟机共享数据内容相同的内存页。
  - 整个物理服务器上的所有虚拟机使用的分配内存总量能超过该服务器的物理内存总量。
- 内存气泡
  - 系统主动回收虚拟机暂时不用的物理内存，分配给需要复用内存的虚拟机。
  - 整个物理服务器上的所有虚拟机使用的分配内存总量不能超过该服务器的物理内存总量。
  - 内存置换：将外部存储虚拟成内存给虚拟机使用，将虚拟机上暂时不用的数据存放到外部存储上。

## 虚拟机特性

### 虚拟机快速部署

- 模板部署
- 虚拟机克隆

### 虚拟机资源热添加

- 热添加指的是在虚拟机开机状态下为虚拟添加计算、存储和网络资源。
- 大部分情况下，资源只支持热添加，而不支持减少。

#### 虚拟机Console控制

虚拟机厂商都为虚拟机配置了Console管理的功能，VMware使用的是Remote Console，华为和KVM使用的VNC的方式。

### 虚拟机快照

虚拟机快照功能是通过存储系统来完成的，SNIA（存储网络行业协会）对快照（Snapshot）的定义是：关于指定数据集合的一个完全可用拷贝，该拷贝包括相应数据在某个时间点（拷贝开始的时间点）的映像。快照可以是其所表示的数据的一个副本，也可以是数据的一个复制品。

常见的快照模式分为两种：

- 写前拷贝（COW，Copy-On-Write）
- 快照写时重定向（ROW，Redirect-On-Write）

### NUMA

非统一内存访问（Non Uniform Memory Access Architecture）

- CPU从绑定的内存（Local Access）中读取数据的响应时间较短
- 而如果跨CPU访问内存（Remote Access）读取数据的响应时间较长
- 既然Local Access速度快，那么就让程序在运行时全部使用一个CPU和与其相绑定的内存，这样就可以提高工作效率，这就是NUMA。
- 使用了NUMA后，它会把CPU和与其绑定的内存当做一个NUMA Node，每个node都有自己内部CPU、总线和内存，如果跨Node进行访问，需通过CPU之间的Interconnect。

## 华为虚拟化产品特性

### 集群特性

#### HA

FusionCompete中集群HA策略

主机故障处理策略

- 原主机恢复虚拟机：当虚拟机所在的主机发生故障时，必须等待主机恢复后，系统才会在原主机重新启动虚拟机。
- HA虚拟机：当虚拟机所在的主机发生故障时，系统会按照集群中设置的虚拟机启动策略重新选择主机启动虚拟机。

主机数据存储故障策略

- 主机数据存储故障处理策略：建议选择“不处理”。当选择“不处理”时，若数据存储故障时间超过“策略延迟”设置的时间，则虚拟机内部会收到IO ERROR，导致操作系统异常。除了“不处理”，还可以选择“HA虚拟机”，选择后若数据存储故障时间超过“策略延迟”设置的时间，系统会按照集群中设置的虚拟机启动策略重新选择主机启动虚拟机。
- 策略延迟（分钟）：执行“主机数据存储故障处理策略”前的延迟时间。在延迟时间内，虚拟机的IO会在后端驱动进行重发处理。策略延迟时间建议设置一个比较大的数值，最大值不超过14400。

虚拟机故障和响应策略

- 不处理
- 重启虚拟机
- HA虚拟机

#### 电源管理（DPM）

电源管理自动化功能会周期性地检查集群中服务器的资源使用情况，如果集群中资源利用率不足，则会将多余的主机下电节能，下电前会将虚拟机迁移至其它主机；如果集群资源过度利用，则会将离线的主机上电，以增加集群资源，减轻主机的负荷。

#### DRS规则

DRS和上面提到的DPM都是负载均衡的一部分。DRS可以通过一定的规则，为系统在进行负载均衡时提供迁移参考。

- 聚集虚拟机：列出的虚拟机必须在同一主机上运行，一个虚拟机只能被加入一条聚集虚拟机规则中。
- 互斥虚拟机：列出的虚拟机必须在不同主机上运行，一个虚拟机只能被加入一条互斥虚拟机规则中。
- 虚拟机到主机：关联一个虚拟机组和主机组并设置关联规则，指定所选的虚拟机组的成员是否能够在特定主机组的成员上运行。

如果不同的规则发生冲突时，规则的调度优先级如下：

- 第一优先级：规则类型为“虚拟机到主机”，规则是“必须在主机组上运行”和“禁止在主机组上运行”的。
- 第二优先级：规则类型为“聚集虚拟机”和“互斥虚拟机”的。
- 第三优先级：规则类型为“虚拟机到主机”，规则是“应该在主机组上运行”和“不应该在主机组上运行”的。

#### IMC

在FusionCompute中，设置集群的IMC策略，使虚拟机可以在不同CPU类型的主机之间进行迁移。

目前IMC策略仅支持Intel不同型号CPU的热迁移。

### 虚拟机特性

#### 虚拟机资源QoS

CPU QoS

虚拟机的CPU QoS用于保证虚拟机的计算资源分配，隔离虚拟机间由于业务不同而导致的计算能力相互影响，满足不同业务对虚拟机计算性能的要求，最大程度复用资源，降低成本。

- CPU资源份额

  CPU份额只在各虚拟机竞争计算资源时发挥作用，如果没有竞争情况发生，有需求的虚拟机可以独占物理CPU资源

- CPU资源预留

  CPU预留定义了多个虚拟机竞争物理CPU资源的时候分配的最低计算资源。

- CPU资源限额

  控制虚拟机占用物理CPU资源的上限。

内存QoS

提供虚拟机内存智能复用功能，依赖内存预留比。

- 内存复用的主要原则是：优先使用物理内存。
- 三参数
  - 内存资源份额
  - 内存资源预留
  - 内存资源限额

网络QoS

网络QoS策略提供带宽配置控制能力，QoS功能不支持同一主机上虚拟机之间的流量限制。包含如下方面：

- 基于端口组成员接口发送方向与接收方向的带宽控制
- 基于端口组的每个成员接口提供流量整形、带宽优先级的控制能力。

