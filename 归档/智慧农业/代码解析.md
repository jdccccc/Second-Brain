# 第一部分：LitsOS代码
LiteOS代码用于控制环境检测板收集环境数据，然后依据MQTT协议将环境数据传输到华为IoT云服务器之上。

## 环境检测与OLED显示
```c
/*环境参数数值获取*/
/*高温预警*/
hi_void get_all_environment_value(hi_void)

{

    hi_u8 combustible_main_menu_gas_value_str[10]={0};

    hi_u8 temperature_str[6] ={0};

    hi_u8 humidity_str[6]={0};

    hi_u8 current_mode = g_current_mode;

    hi_i2c_init(HI_I2C_IDX_0, HI_I2C_IDX_BAUDRATE);

    hi_i2c_set_baudrate(HI_I2C_IDX_0, HI_I2C_IDX_BAUDRATE);

    while(1) {
        get_aht20_sensor_datat();

        mq2_get_data();
        
        flaot_to_string(aht_temper, temperature_str);

        flaot_to_string(aht_humi, humidity_str);  

        flaot_to_string(g_combustible_gas_value, combustible_main_menu_gas_value_str); 

        hi_u32 cnt;

        if(aht_temper > 31){

            if(aht_temper > 32.5){

                hi_pwm_start(HI_PWM_PORT_PWM0, 2*PWM_DUTY, PWM_FULL_DUTY);

                hi_udelay(DELAY_250_MS);

            }else{

                hi_pwm_start(HI_PWM_PORT_PWM0, 2*PWM_DUTY, PWM_FULL_DUTY);

                hi_udelay(DELAY_1_s);

                hi_pwm_start(HI_PWM_PORT_PWM0, 1, PWM_FULL_DUTY);

                hi_udelay(DELAY_1_s);

            }

        }

  

        oled_show_str(18,5,temperature_str,1);

        oled_show_str(81,5,humidity_str,1);  

        if (!g_combustible_gas_value)   {

             oled_show_str(48,6,"0.00    ",1);

        } else {

            oled_show_str(48,6,combustible_main_menu_gas_value_str,1);

        }      

        if (current_mode != g_current_mode) {

            break;

        }

  

        hi_sleep(SLEEP_10_MS);//10ms

    }

}

/*环境菜单OLED显示*/
hi_void environment_show(hi_void)

{

    hi_i2c_init(HI_I2C_IDX_0, HI_I2C_IDX_BAUDRATE);

    hi_i2c_set_baudrate(HI_I2C_IDX_0, HI_I2C_IDX_BAUDRATE);


    while( HI_ERR_SUCCESS != oled_init()) {

         printf("Connecting oled board falied!Please access oled board\r\n");

         if (hi3861_board_led_test == 0) {

            hi3861_board_led_test =1;

             /*test HiSpark board*/

            FACTORY_HISPARK_BOARD_TEST("-----------HiSpark board test----------");  

         }

         hi_sleep(SLEEP_1S);

    }
    extern hi_void test_gpio_init(hi_void);

    test_gpio_init();

    while (1) {
                 oled_fill_screen(OLED_CLEAN_SCREEN);//clean screen

                 oled_show_str(0,0, "     4C_CCNU    ",1);

                 oled_show_str(0,1, "        -       ",1);

                 oled_show_str(0,2, "  _____//_____  ",1);

                 oled_show_str(0,3, " /o _  |   _|_  ",1);

                 oled_show_str(0,4, " `-(_)----(_)-  ",1);

                 oled_show_str(0,5, "T:    C H:    % ",1);

                 oled_show_str(0,6, "C_Gas:00        ",1);

                 oled_show_str(0,7, "                ",1);

                 get_all_environment_value();
	}

}
```
## MQTT协议IoT云数据传输
本部分代码主要构建了MQTT协议，并且将设备环境属性数据按照IoTA的要求上报至IoT云的设备模型属性当中。
```c
/*在LiteOS操作系统当中创建消息队列和MainEntry任务*/
int IoTMain(void)

{

    hi_u32 ret;

    hi_task_attr attr = {0};

  

    ret = hi_msg_queue_create(&gIoTAppCb.queueID, CN_QUEUE_MSGNUM,CN_QUEUE_MSGSIZE);

    if (ret != HI_ERR_SUCCESS) {

       IOT_LOG_ERROR("消息队列创建失败!\r\n");

    }

  

    attr.stack_size = CN_TASK_STACKSIZE;

    attr.task_prio = CN_TASK_PRIOR;

    attr.task_name = CN_TASK_NAME;

    ret = hi_task_create(&gIoTAppCb.iotTaskID, &attr, MainEntry, NULL);

    if (ret != HI_ERR_SUCCESS) {

       IOT_LOG_ERROR("创建MainEntry任务失败！\r\n");

    }

    return 0;

}

/*根据config文件中的设置设置MQTT网络连接*/
static hi_void *MainEntry(hi_void *arg)

{

    while(gIoTAppCb.stop == HI_FALSE)

    {

        MainEntryProcess();

        IOT_LOG_DEBUG("The connection lost and we will try another connect\r\n");

        hi_sleep(1000*5);

    }

    return NULL;

}


/*待连接Wifi后，每一秒主动上报一次MQTT数据*/
static hi_void *DemoEntry(hi_void *arg)

{
    hi_watchdog_disable();

    extern hi_void WifiStaReadyWait(hi_void);

	//等待Wifi连接
    WifiStaReadyWait();

    extern void cJsonInit(void);

    cJsonInit();

    IoTMain();

    IoTSetMsgCallback(DemoMsgRcvCallBack);
    while (1){
    
        hi_sleep(1000);
        
        oc_environment_status_report(ENV_ALL_MODE, setup_env_all_module);
        
	}
	
    return NULL;

}

/*设置上报IoTA的设备属性，设备服务，设备模型*/
hi_void setup_env_reality_value(hi_environment_mode current_mode, hi_control_mode_type current_type)

{

    IoTProfileService_t service;

    IoTProfileKV_t property;

  

    printf("environment:env all module\r\n");

    if (current_mode != ENV_ALL_MODE) {

        printf("select current module is not the ENV_ALL_MODE\r\n");

        return HI_NULL;

    }

	//实时温度
    memset(&property, 0, sizeof(property));

    property.type = EN_IOT_DATATYPE_STRING;

    property.key = "实时温度";

    property.value = g_ahu20_temperature_buff;

    memset(&service, 0,sizeof(service));

    service.serviceID = "Environment";

    service.serviceProperty = &property;

    IoTProfilePropertyReport(CONFIG_DEVICE_ID,&service);

	//实时湿度

    memset(&property, 0, sizeof(property));

    property.type = EN_IOT_DATATYPE_STRING;

    property.key = "实时湿度";

    property.value = g_ahu20_humidity_buff;

    memset(&service, 0,sizeof(service));

    service.serviceID = "Environment";

    service.serviceProperty = &property;

    IoTProfilePropertyReport(CONFIG_DEVICE_ID,&service);

	//可燃性气体浓度
    memset(&property, 0, sizeof(property));

    property.type = EN_IOT_DATATYPE_STRING;

    property.key = "实时可燃性气体浓度";

    property.value = g_ahu20_gas_buff;

    memset(&service, 0,sizeof(service));

    service.serviceID = "Environment";

    service.serviceProperty = &property;

    IoTProfilePropertyReport(CONFIG_DEVICE_ID,&service);

}
```

# 第二部分：云数据后端
云数据后端代码用于从IoTA云上的AMQP队列中拉取json数据，亦即环境数据，然后响应前端界面的get请求
## 响应前端get请求
本部分代码负责响应前端的get请求，将从IoTA云服务器上拉取的数据拉取到前端界面。
```java
@RestController

@RequestMapping("/demo")

public class DemoController {

  

    @RequestMapping(value = "/index", method= RequestMethod.GET)

    public String index(){

        try {

            String con = ApplicationAMQPJavaDemo.getmessage();

            JSONObject jsonmessage = JSONObject.parseObject(con);

            JSONObject notify_data=jsonmessage.getJSONObject("notify_data");

            JSONObject body=notify_data.getJSONObject("body");

            JSONArray array=body.getJSONArray("services");

            JSONObject array0=array.getJSONObject(0);

            JSONObject properties=array0.getJSONObject("properties");

            String data=JSONObject.toJSONString(properties);

            System.out.println(data);

            return data;

        }catch (Exception e) {

            e.printStackTrace();

            String err="100";

            return err;

        }

  

    }
}
```
## 从AMQP队列当中拉取数据
IoT云当中设置MQTT接口一旦接收到数据的属性上报，就会触发数据流转规则，将设备的属性消息转发到默认的AMQP队列当中去，此程序需要调用IoTA提供的AMQP的API接口拉取新更新的设备属性上报信息，也就是上报的环境属性数据。
```java
public class ApplicationAMQPJavaDemo {

    //异步线程池，参数可以根据业务特点作调整，也可以用其他异步方式来处理。

    private final static ExecutorService executorService = new ThreadPoolExecutor(

            Runtime.getRuntime().availableProcessors(), Runtime.getRuntime().availableProcessors() * 2,

            60, TimeUnit.SECONDS, new LinkedBlockingQueue<>(5000));

  

    public static String getmessage() throws Exception {

        //连接凭证接入键值。

        String accessKey = "Vw2NmrD2";

        long timeStamp = System.currentTimeMillis();

        //UserName组装方法，请参见文档：AMQP客户端接入说明。

        String userName = "accessKey=" + accessKey + "|timestamp=" + timeStamp;

        //连接凭证接入码。

        String password = "bEdWToiJ9CnWXI4c6EVPmGIU65gCyeYg";

        //按照qpid-jms的规范，组装连接URL。

        String baseUrl = "a161b9c0de.iot-amqps.cn-north-4.myhuaweicloud.com";

        String connectionUrl = "amqps://" + baseUrl + ":5671?amqp.vhost=default&amqp.idleTimeout=8000&amqp.saslMechanisms=PLAIN";

        Hashtable<String, String> hashtable = new Hashtable<>();

        hashtable.put("connectionfactory.HwConnectionURL", connectionUrl);

        //队列名，可以使用默认队列DefaultQueue

        String queueName = "DefaultQueue";

        hashtable.put("queue.HwQueueName", queueName);

        hashtable.put(Context.INITIAL_CONTEXT_FACTORY, "org.apache.qpid.jms.jndi.JmsInitialContextFactory");

        Context context = new InitialContext(hashtable);

        JmsConnectionFactory cf = (JmsConnectionFactory) context.lookup("HwConnectionURL");

        //同一个链接可创建多个queue,与前面queue.HwQueueName作好配对就行

        Destination queue = (Destination) context.lookup("HwQueueName");

  

        //信任服务端

        TransportOptions to = new TransportOptions();

        to.setTrustAll(true);

        cf.setSslContext(TransportSupport.createJdkSslContext(to));

  

        // 创建连接

        Connection connection = cf.createConnection(userName, password);

        ((JmsConnection) connection).addConnectionListener(myJmsConnectionListener);

        // 创建 Session

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        connection.start();

        // 创建 Receiver Link

        MessageConsumer consumer = session.createConsumer(queue);

        System.out.println(messageout(consumer));

        return messageout(consumer);

    }
```

# 第三部分：前端界面
前端界面负责在用户在浏览器输入本项目网址时得到前端页面展示，并且能够实时查看自己的环境检测板产品所检测得到的环境数据
## 前端界面HTML模块设计
前端界面HTML代码过长，本处简要列出核心设计模块
```HTML
    <section class="hero-header primary-header slider-header" id="home"></section>

    <div class="brands"></div>

    <section id="about-us" class="work section"></section>

    <section class="services-area section" id="features"></section>

    <section class="product-counter-section"></section>

    <section id="pricing" class="pricing-table section"></section>  

    <section id="team" class="team section"></section>

    <section id="faq" class="faq-section section"></section>

    <section id="contact-us" class="contact-us section"></section>

    <section id="get-started" class="get-started section"></section>

    <section id="footer" class="section footer"></section>

```

## 向后端的get请求
每当用户按下获取数据的按钮的时候，前端界面就会通过浏览器向云数据后端发起get数据请求，得到更新数据后立刻更新界面
```HTML
    <script>

        $(document).ready(function(){

            $("#Tem").click(function(){

                for( i = 0; i < 3; i++){

                var http = new XMLHttpRequest();

                http.open("GET","http://192.168.43.118:8080/demo/index")

                http.onload = function() {

                    var res = http.responseText

                    var obj = JSON.parse(res);

                    for (var key in obj) {

                        if(key == "实时温度"){

                            $("#TemExp").text(obj.实时温度+"℃");

                            alert(obj[key]);

                        }

                        else if(key == "TemperatureModule"){

                            $("#TemExp").text(obj.TemperatureModule+"℃");

                            alert(obj[key]);

                        }

                    }                  

                }

                http.send()

                }

            });

        });

    </script>
```