# 雾点设计方案

## 硬件部分
### 数据设计
硬件部分主要负责从农田雾点当中收集出相关农田参数：
参数包括：
- 土壤湿度
- 空气温度
- 空气湿度
- 图像采集
- 水流流通量
- 设备电压

### 硬件设备简介
1. 霍尔流量计/涡轮流量传感器
	- 作用：
		负责从水龙头定量引入水流，便于作物的水流智能化控制
	- 参数：
		![[Pasted image 20220407193313.png]]
		![[Pasted image 20220407192957.png]]
		 ![[Pasted image 20220407193023.png]]

2. 4分/6分 DC12V常闭进水阀
	- 作用：用于控制霍尔流量计的开关，实现精准水流孔子
	- 参数：
	![[Pasted image 20220407193545.png]]

3. 双输出开关电源正负12V15V
	- 作用：用于给雾点中的不同设备提供相应电压的电流，确保设备稳定运转。
	- 参数：两种电压输出

4. 土壤湿度计检测模块
	- 作用：用于采集土壤中的湿度，将该数据上传至IoT云进行后置分析。
	- 产品介绍:
		![[Pasted image 20220407194026.png]]
	- 参数：
	![[Pasted image 20220407194058.png]]

5. Hi3861环境监测套件
- 作用：雾点核心硬件，搭载OpenHarmony系统，用于收集来自于各个传感器的电信号，通过系统内设置的程序将电信号转换成既定格式的数据，再转发到IoT云端，进行进一步的数据管理和分析。
- 参数：（随便CopyCopy）
- 产品介绍：（Copy too）

### 硬件配置
#### 十字型部署（方案一)
1. 硬件设备
	1. 土壤湿度传感器$\times 1$
	2. 空气温湿度传感器$\times 1$
	3. 电磁水阀$\times 5$
	4. 霍尔流量传感器$\times 5$
	5. 摄像头$\times 1$
	6. Hi3861$\times 1$
	7. 直流电源$\times 1$

#### 星型部署（方案二） 
1. 硬件设备
	1. 土壤湿度传感器$\times 3$
	2. 空气温湿度传感器$\times 1$
	3. 电磁水阀$\times 1$
	4. 霍尔流量传感器$\times 1$
	5. 摄像头$\times 1$
	6. Hi3861$\times 1$
	7. 直流电源$\times 1$

#### 日字型（方案三）
1. 硬件设备
	1. 土壤湿度传感器$\times 1$
	2. 空气温湿度传感器$\times 1$
	3. 电磁水阀$\times 2$
	4. 霍尔流量传感器$\times 2$
	5. 摄像头$\times 1$
	6. Hi3861$\times 1$
	7. 直流电源$\times 1$

### 电路串接图（需要老师指导）
#### 十字型部署（方案一）
待定
#### 星型部署（方案二）
待定
#### 日字型部署（方案三）
1.土壤湿度传感器连接


## 软件部分
#### 十字型部署（方案一）
待定
#### 星型部署（方案二）
待定
#### 日字型部署（方案三）
##### 总体流程
1. 检测联网状态
2. 测试硬件
3. 没联网
3.1本地简单自动模式。缺水浇水
3.2本地AI自动模式。
4. 有联网
4.1完全用户自主模式
4.2专家辅助模式
4.3AI专家模式
5. 进入各模式

注解：完全用户自主模式下的土地安全问题。
无网时需随时入本地模式。
无网时各阀门定时10分钟（定时时间可以设置）关闭。

#### 完全用户自主模式
接受命令
执行命令

命令：
开水阀
关水阀
土壤湿度查询
空气温湿度查询
流量计读取
开关摄像头及拍照

```C
//用户模式选择
	int N;//N表示模式
	Rec_Mode(N);//表示接受用户指定的运行模式（四种）
	switch(N)//根据选定的运行模式执行相应的模式操作

//完全用户自主模式
#define OpenTap 0
struct 
bool Com_User_Auto_Mode(){
	 CommadNum = MQTT_Rec_Cmd();//由MQTT网络组，查询接收到的命令
	switch(CommandNum){
		case OpenTap://开水阀
		case :
	}
	
}

//
bool Open_WaterShed(int a, int b){
	
	return true;
}
```


土壤湿度查询

土壤湿度查询命令，类同开水阀

获得土壤湿度数值需要AD转换。


空气温湿度查询

I2C接口的读写。

流量计读写。

霍尔传感器，通过GPIO读取脉冲实现

开关摄像头及拍照，待攻关。

联网和MQTT传输



雾点系统的软件部分主要以Hi3861芯片为核心构建在OpenHarmony操作系统之上，主要完成两部分的任务：
1. 从各硬件传感器端接受电信号并经过函数解析成为需求规约中既定的数据参数形式；
2. 将各个传感器经过解析的数据整合成Json形式转发到MQTT协议构建的数据网络之中，传输到IoT云端。

## 程序实现设计
在Open Harmony中编写电信号解析程序，每个程序包含三部分：
1. 电信号接收部分：主要调用OpenHarmony提供的串口信号接收API（请参考文档放上五个硬件对应信号形式的OpenHarmony函数）；
2. 电信号解析部分：查看参考资料和店家提供的引脚信号资料，编写相关的函数，通过初等数学变形得到电信号表达的实际含义、实际数据；
3. MQTT网络转接部分：按照OpenHarmony官方文档
	1. 找到开启和连接Wifi的实例程序或者API函数，实现hi3861的Wifi连接
	2. 参考官方文档找到OpenHarmony的MQTT协议相关的配置函数，将Hi3861接入MQTT协议网
	3. 参考官方文档找到OpenHarmony的MQTT协议的数据传输函数，将刚刚的电信号解析函数输出的解析后数据以Json格式通过MQTT组网转发到IoT云上

