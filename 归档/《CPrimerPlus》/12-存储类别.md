---
title: 12.存储类别
date: 2021-08-05 18:45:53
tags: C
---

# 12.存储类别、链接和内存管理

## 存储类别

`用存储期描述对象，所谓存储期是指对象在内存中保留了多长时间；标识符用于访问对象，可以用作用域和链接描述标识符`

对象表示存储一个值所占据的一块内存空间这样一个抽象概念，变量是一种对象，字符串常量也是一种对象，等等

### 作用域

**作用域描述程序中可访问标识符的区域**

- 块作用域（具有块作用域的变量称作局部变量）
    - 范围是从定义处到包含该定义的块的末尾
    - 形式参数声明在函数的左花括号之前，但是它们的作用域也属于函数体这个块
    - C99把块的概念扩展到for、while、do while、if所控制的代码中
- 函数原型作用域
    - 从函数原型中的形参定义到原型声明结束
- 函数作用域
    - 用于goto
- 文件作用域（具有文件作用域的变量也称为全局变量）
    - 从它的定义处到该定义所在文件的末尾
- 翻译单元和文件P375

### 链接

- 外部链接
- 内部链接
- 无链接
    - 具有块作用域、函数原型作用域、函数作用域的变量都是无链接变量
    - 具有文件作用域的变量可以是外部链接或内部链接
        - 外部链接变量可以在多文件程序中使用
        - 内部链接变量只能在一个翻译单元中使用
- 文件作用域、程序作用域、全局作用域P376正式和非正式术语

### 存储期

- 静态存储期
    - 程序执行期间一直存在
- 自动存储期
    - 块始块末
- 线程存储期
- 动态分配存储期

### 存储类别说明符

| 存储类别     | 存储期 | 作用域 | 链接 | 声明方式           |
| ------------ | ------ | ------ | ---- | ------------------ |
| 自动         | 自动   | 块     | 无   | 块内、auto         |
| 寄存器       | 自动   | 块     | 无   | 块内、register     |
| 静态外部链接 | 静态   | 文件   | 外部 | 所用函数外、extern |
| 静态内部链接 | 静态   | 文件   | 内部 | 所有函数外、static |
| 静态无链接   | 静态   | 文件   | 无   | 块内、static       |

- 内层块会**隐藏**外部块的定义
- 整个循环是它所在块的子块，循环体是整个循环块的子块
- 支持C99和C11，P380
- 自动变量不会初始化，除非显示初始化，否则为任意垃圾值；
- 静态变量隐式初始化为0
- 寄存器变量无法获取地址
- 不能在函数的形参中使用static
- 只能用常量表达式初始化文件作用域变量（属于静态存储期），但是可以用非常量表达式初始化自动变量（包含块作用域）
- 第一次声明外部变量被称为定义式声明，第二次声明被称为引用式变量
- 不能用extern创建外部定义，只能用它来引用现有的外部定义
- 一个变量可以有多个引用式声明，但只能有一个定义式声明

|               | 存储期         | 作用域           |
| ------------- | -------------- | ---------------- |
| _Thread_local |                |                  |
| typedef       |                |                  |
| auto          | 自动存储期     | 只能用于块作用域 |
| register      | 寄存器存储     | 只能用于块作用域 |
| static        | 静态存储期     | 文件、块         |
| extern        | 声明文件作用域 |                  |

存储类别总结P387

### 存储类别和函数

函数的存储类别

- 外部函数
    - 一般函数声明默认为extern
    - 定义默认为外部函数
- 静态函数
    - 定义时使用static

## 随机数函数和静态变量

P390

P392自动重置种子

## 分配内存：malloc()和free()

**malloc()函数**

- 该函数接受一个参数——所需的内存字节数
- 返回动态分配内存块的首字节地址，指向void的指针
    - 可以强制转换为匹配的类型增加可读性
    - 不过把void指针赋给任意类型的指针完全不用考虑类型匹配的问题
    - 如果分配内存失败返回空指针
- 三种创建数组的方法
    - 声明时常量指定大小
    - 声明时变量指定
    - 声明一个指针，调用malloc，将其返回值赋给指针

**free()函数**

- 参数是之前malloc返回的地址
- 动态分配内存的存储期从调用malloc分配内存到调用free释放内存为止

**内存泄漏**

malloc分配的内存忘记使用free释放

**calloc函数**

- 接受两个无符号整数作为参数（size_t)
    - 第一个是所需的存储单元数量
    - 第二个是存储单元的大小
- 把所有块中的为都设置为0
- free(）释放

## 存储类别和存储位置

内存分为三部分

- 静态对象（三种链接的静态变量+字符串字面量）
- 自动对象——栈
- 动态分配对象——堆

## ANSI C 类型限定符

P402

- 类型
- 存储类别
- C90:恒常性const、易变性volatile（代理可改变，const和volatile可以同时设置一个值）
- C99:restrict（只能用于指针，表明指针是访问数据对象的唯一且初始的方式）、幂等
- C11:_Atomic