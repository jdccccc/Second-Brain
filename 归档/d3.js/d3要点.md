---
title: d3要点
date: 2021-05-09 22:28:57
tags: d3
---

# D3要点

### 简介

- D3是一个数据驱动文档的js库
- 主要操作DOM对象及其数据

### 绑定数据

通过 D3 的 selection.data() 方法把数据绑定到 DOM 元素。

必须具备两个条件：  

- 数据； 
- 选中的 DOM 元素。

### 加载数据

#### CSV

```
d3.csv("food.csv", function(data) {
 console.log(data);
});
```

<!--注意-->

- CSV 中的每个值都是以字符串形式保存的，连数字都是。
- d3.csv()是一个异步方法。只能在回调函数内部（或回调函数调用的其他函数中）引用数据。
  1. 先声明一个全局变量
  2. 然后再调用d3.csv()加载数据。
  3. 在回调函数中，把数据复制给这个全局变量（以方便后面的函数使用该数据），
  4. 最后再调用依赖数据显示图形的其他函数。

#### JSON

```
d3.json("waterfallVelocities.json", function(json) {
 console.log(json); // 输出到控制台
});
```

### 选择

```
d3.select("body").selectAll("p")
 .data(dataset)
 .enter()
 .append("p")
 .text("New paragraph!");
```

• d3.select("body")

选择 DOM 中的 body 元素，把它交给连缀方法中的下一个方法。 

• .selectAll("p")

选择 DOM 中的所有段落。因为还没有段落，所以返回空元素。可以认为这个空 

元素代表马上就会创建的段落。 

• .data(dataset)

解析并数出数据值。dataset 数组中有 5 个值，因而此后的所有方法都将执行五 

遍，每次针对一个值。 

• .enter()

要创建新的绑定数据的元素，必须使用 enter()。这个方法会分析当前选择的 

DOM 元素和传给它的数据，如果数据值比对应的 DOM 元素多，就创建一个新 

的**占位元素**。然后把这个新占位元素的引用交给链中的下一个方法。 

• .append("p")

取得由 enter() 创建的空占位元素，并把一个 p 元素追加到相应的 DOM 中。太 

棒了！然后它再把自己刚创建的元素交给链中的下一个方法。 

• .text("New paragraph!")

取得新创建的 p 元素，插入文本值。

### 使用数据

```
        d3.select("body").selectAll("p")
            .data(dataset)
            .enter()
            .append("p")
            .text(function(d) {
                return d;
            });
```

### 添加样式

```
<body>
    <script type="text/javascript">
        var dataset = [5, 10, 15, 20, 25];
        d3.select("body").selectAll("p")
            .data(dataset)
            .enter()
            .append("p")
            .text(function(d) {
                return "Number" + d;
            })
            .style("color", function(d) {
                if (d >= 20)
                    return "red";
                else
                    return "blue";
            })
    </script>
</body>
```

## 基于数据绘图

### 入门简单实例

#### 实例一

![image-20210509162823144](/images/image-20210509162823144.png)

```
<body>
    <script type="text/javascript">
        var dataset = [2, 4, 6, 8, 10];
        d3.select("body")
            .selectAll("div")
            .data(dataset)
            .enter()
            .append("div")
            .attr("class", "bar")
            .style("height", function(d) {
                var barheight = d * 5;
                return barheight + "px";
            })
    </script>
</body>
```

#### 实例二

![image-20210509163823456](/images/image-20210509163823456.png)

```
<body>
    <script type="text/javascript">
        var dataset = []; // 初始化空数组
        for (var i = 0; i < 25; i++) { // 循环 25 次
            var newNumber = Math.floor(Math.random() * 30); // 生成介于 0 到 30 之间的随机数
            //random-随机浮点数；round-1->30的整数
            dataset.push(newNumber); // 把新数值添加到数组中
        }
        d3.select("body")
            .selectAll("div")
            .data(dataset)
            .enter()
            .append("div")
            .attr("class", "bar")
            .style("height", function(d) {
                var barheight = d * 5;
                return barheight + "px";
            })
    </script>
</body>
```

#### 实例三

![image-20210509170509841](/images/image-20210509170509841.png)

```
<body>
    <script type="text/javascript">
        var w = 500,
            h = 100,
            dataset = [5, 10, 15, 20, 25];


        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var circles = svg.selectAll("circle")
            .data(dataset)
            .enter()
            .append("circle");

        circles.attr("cx", function(d, i) {
                return i * 50 + 25;
            })
            .attr("cy", h / 2)
            .attr("r", function(d) {
                return d;
            })
            .attr("fill", "yellow")
            .attr("stroke", "orange")
            .attr("stroke-width", function(d) {
                return d / 2;
            });
    </script>
</body>
```

### 条形图

![image-20210509173834134](/images/image-20210509173834134.png)

```
<body>
    <script type="text/javascript">
        var w = 500,
            h = 300,
            barPadding = 1,
            dataset = [5, 10, 13, 19, 21, 25, 22, 18, 15, 13,
                11, 12, 15, 20, 18, 17, 16, 18, 23, 25
            ];

        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var rect = svg.selectAll("rect")
            .data(dataset)
            .enter()
            .append("rect")
            .attr("x", function(d, i) {
                //return i * 21; //静态实现横向排列
                return i * (w / dataset.length);
                //动态实现横向平均排列
            })
            .attr("y", function(d) {
                return h - d * 4;
            })
            .attr("width", (w / dataset.length) - barPadding)
            .attr("height", function(d) {
                return d * 4;
            })
            .attr("fill", function(d) {
                return "rgb(0,0," + d * 10 + ")";
                //数字与字符串相加变成数字字符
            });
    </script>
</body>
```

<!--先版本attr似乎不支持多值映射-->

![image-20210509181409102](/images/image-20210509181409102.png)

```
        var text = svg.selectAll("text")
            .data(dataset)
            .enter()
            .append("text")
            .text(function(d) {
                return d;
            })
            .attr("x", function(d, i) {
                return i * (w / dataset.length) + (w / dataset.length - barPadding) / 2;
            })
            .attr("y", function(d) {
                return h - d * 4 + 15;
            })
            .attr("font-family", "sans-serif")
            .attr("font-size", "11px")
            .attr("fill", "white")
            .attr("text-anchor", "middle");
```

### 散点图

![image-20210509215205972](/images/image-20210509215205972.png)

```
<body>
    <script type="text/javascript">
        var w = 500,
            h = 100,
            barPadding = 1;
        var dataset = [
            [5, 20],
            [480, 90],
            [250, 50],
            [100, 33],
            [330, 95],
            [410, 12],
            [475, 44],
            [25, 67],
            [85, 21],
            [220, 88]
        ];

        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var circles = svg.selectAll("circle")
            .data(dataset)
            .enter()
            .append("circle");

        circles.attr("cx", function(d) {
                return d[0];
            })
            .attr("cy", function(d) {
                return d[1];
            })
            .attr("r", function(d) {
                return Math.sqrt(h - d[1]);
            });

        var txt = svg.selectAll("text")
            .data(dataset)
            .enter()
            .append("text")
            .text(function(d) {
                return d[0] + ',' + d[1];
            })
            .attr("x", function(d) {
                return d[0];
            })
            .attr("y", function(d) {
                return d[1];
            })
            .attr("font-size", "11px")
            .attr("fill", "red")
    </script>
</body>
```

## 比例尺

